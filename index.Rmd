---
title: "The Opioid Epidemic"
author: "Chris Murphy, Tamer Sullivan, and Sean Wei"
date: "11/19/2020"
output:
  rmdformats::readthedown:
    thumbnails: false
    highlight: NULL
---

```{r setup, include = FALSE}
library(tidyverse)
library(plotly)
library(ggrepel)
library(maps)
library(mosaic)

knitr::opts_chunk$set(echo = TRUE, fig.align="center")
```

# Introduction (Tamer)

The Opioid Crisis is truly that - a crisis. Over the past 20 years, 

# Data

## Prescription Rate Data (Tamer)

## Overdose Rate Data (Chris)

# Analysis

## Prescription Rate vs. Overdose Rate (Chris)

1. Show maps
2. Ask Questions about whether one causes the other, etc.

```{r, include = FALSE, warning = FALSE}
# Read in data
prescription_data <- readRDS(file = "prescription_data.rds")
overdose_data <- readRDS(file = "all_overdoses.rds")

full_data <- left_join(prescription_data, overdose_data, by = c("year", "State")) %>% 
  janitor::clean_names() %>% 
  filter(year == 2014) %>% 
  mutate_if(is.numeric, funs(`std`=scale(.) %>% as.vector())) %>% 
  select(state, prescription_rate_std, age_adjusted_rate_std, prescription_rate, age_adjusted_rate)
  
# Initialize map data
usa_states <- map_data(map = "state", region = ".")

# Join map data to other data
prescription_map <- prescription_data %>% 
        filter(year == "2014") %>% 
        inner_join(usa_states, by = c("state" = "region")) %>%
        rename(`Prescription Rate` = prescription_rate)
overdose_map <- overdose_data %>% 
        filter(year == "2014") %>% 
        mutate(State = tolower(State)) %>% 
        inner_join(usa_states, by = c("State" = "region")) %>% 
        rename(`Overdose Rate` = Age.Adjusted.Rate)

```

```{r, echo=FALSE, warning=FALSE}
# Plot 2014 Prescription Rate data
ggplotly(
      ggplot(prescription_map, aes(x = long, y = lat, group = group, 
                                       fill = `Prescription Rate`)) +
        geom_polygon(color = "white", aes(text = paste0('State: ', str_to_title(state)))) +
        theme_void() +
        coord_fixed(ratio = 1.3) +
        labs(fill = "Prescription Rate") +
        theme(legend.position = "bottom") +
        scale_fill_distiller(palette = "Oranges", direction = 2) + 
        ggtitle("Opioid Prescription Rates - 2014")
)

# Plot 2014 Overdose Rate data  
ggplotly(
  ggplot(overdose_map, aes(x = long, y = lat, group = group,
                                   fill = `Overdose Rate`)) +
        geom_polygon(color = "white", 
                     aes(text = paste0('State: ', 
                                      str_to_title(State), 
                                      '<br>', 
                                      'Deaths: ', Deaths))) +
        theme_void() +
        coord_fixed(ratio = 1.3) +
        labs(fill = "Overdose Rate") +
        theme(legend.position = "bottom") +
        ggtitle("Opioid Overdose Rates - 2014") +
        scale_fill_distiller(palette = "Blues", direction = 2)
)
```      

## Regression

```{r warning = FALSE}
# scatter / regression between prescription rate and overdose rate
mod <- lm(age_adjusted_rate ~ prescription_rate, data = full_data)
msummary(mod)
```

```{r}
ggplot(data = full_data, aes(x = prescription_rate)) +
  geom_histogram(bins = 15)
```


```{r}
ggplot(data = full_data, aes(x = prescription_rate, y = age_adjusted_rate)) +
  geom_point() + 
  geom_abline(intercept = 7.56323, slope = 0.10475)
```


# Clustering (Sean)

Text explaining why k-means

## Determining the Optimal K

Explain silhouette score

```{r}
silhouette_score <- function(k){
  km <- kmeans(full_data[, 2:3], centers = k, nstart = 20)
  score <- cluster::silhouette(km$cluster, dist(full_data[, 2:3]))
  mean(score[, 3])
}

k <- 2:5
avg_sil <- sapply(k, silhouette_score)
optimal_k <- which(as.data.frame(avg_sil)$avg_sil == max(avg_sil)) + 1
optimal_k

km <- kmeans(full_data[, 2:3], centers = optimal_k, nstart = 20)
full_data <- mutate(full_data, cluster = as.character(km$cluster))
```

## Clustering for 2014

```{r echo = FALSE}
ggplot(data = full_data, aes(x = prescription_rate_std, y = age_adjusted_rate_std)) + 
  geom_point(aes(color = cluster)) +
  geom_text_repel(aes(label = state, color = cluster), size = 3) +
  geom_point(data = as.data.frame(km$centers)
             , aes(x = prescription_rate_std, y = age_adjusted_rate_std)
             , pch = "X"
             , size = 3) +
  labs(x = "Prescription Rate", y = "Age Adjusted Overdose Rate", color = "Cluster Assignment") + 
  ggtitle("Clustering for 2014")
```

```{r echo = FALSE}
usa_states <- map_data(map = "state", region = ".") %>% 
  mutate(state = stringr::str_to_title(region))

cluster_map <- full_data %>%
  inner_join(usa_states, by = "state")

ggplot(cluster_map, aes(x = long, y = lat, group = group, fill = cluster)) +
      geom_polygon(color = "white") +
      theme_void() +
      coord_fixed(ratio = 1.3) +
      labs(title = "Opioid Prescription Rate by State",
           subtitle = "MME Prescribed per 100 People",
           fill = "") +
      theme(legend.position="right")
```

text about the clustering

# Conclusion (Chris, Sean)
